# 八字能量计算算法规范文档 V2.1

> **文档版本**: V2.1 (已实施)  
> **更新日期**: 2026-02-20  
> **适用项目**: 玄学时机应用系统 (Vue3 SPA)  
> **核心文件**: `src/utils/tyme.js`

---

## 1. 算法概述

### 1.1 算法目的

根据用户的出生八字（生辰八字），计算查询日期不同时辰的能量分数，为用户提供"最佳时机"决策依据。V2.1 版本重点优化了**评分友好度**和**文案可读性**，旨在提供更积极、正向的用户体验。

### 1.2 输入参数

| 参数        | 类型   | 说明                                       |
| ----------- | ------ | ------------------------------------------ |
| `userBazi`  | Object | 用户八字：年柱、月柱、日柱、时柱           |
| `userGods`  | Object | 用户喜忌神数组：favorable[]、unfavorable[] |
| `queryDate` | Date   | 查询日期时间                               |

### 1.3 输出结果

| 字段      | 类型   | 说明                     |
| --------- | ------ | ------------------------ |
| `score`   | Number | 能量分数 (20-95)         |
| `level`   | String | 等级：大吉/吉/平/凶/大凶 |
| `shenSha` | Array  | 神煞信息（贵人、桃花等） |
| `clashes` | Array  | 冲煞信息（日破、岁破等） |
| `reason`  | String | 评分依据描述（友好文案） |

---

## 2. 核心算法设计 (V2.1)

### 2.1 计算维度总览

```
┌─────────────────────────────────────────────────────────────┐
│                    总能量分数 (0-100)                        │
├─────────────────────────────────────────────────────────────┤
│  基础分: 60 (原50)                                           │
├─────────────────────────────────────────────────────────────┤
│  + 日柱影响 (±25)                                           │
│    ├─ 日柱天干 vs 日主 (生助+15、同类+10、克制-8)            │
│    └─ 日柱地支 vs 日主地支 (六合+12、六冲-10)                │
├─────────────────────────────────────────────────────────────┤
│  + 时辰影响 (±20)                                           │
│    ├─ 时辰天干 vs 日主 (生助+12、同类+8、克制-6)             │
│    ├─ 时辰地支 vs 日主地支 (六合+10、六冲-8)                 │
│    └─ 时辰 vs 日柱 (六合+8、六冲-6)                          │
├─────────────────────────────────────────────────────────────┤
│  + 神煞影响 (±15)                                           │
│    ├─ 天乙贵人 +18 (大吉)                                    │
│    ├─ 文昌贵人 +10                                           │
│    ├─ 桃花 +5                                                │
│    ├─ 驿马 +3                                                │
│    └─ 冲煞(日破/岁破) -10 (降低惩罚)                         │
├─────────────────────────────────────────────────────────────┤
│  + 特殊组合 (±10)                                           │
│    ├─ 日柱+时柱双合 +10                                      │
│    ├─ 双冲 -12                                               │
│    ├─ 三合局 +8                                              │
│    └─ 三会局 +8                                              │
├─────────────────────────────────────────────────────────────┤
│  = 最终分数 (限制范围: 20-95)                                │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 友好化调整详情 (Friendly Scoring)

为了减少用户的焦虑感，提升使用体验，V2.1 对评分标准进行了以下调整：

1.  **基础分提升**: 从 50 分提升至 **60 分**，确保起跑线在及格线以上。
2.  **吉星权重增加**:
    *   天乙贵人：+15 → **+18**
    *   文昌贵人：+8 → **+10**
    *   桃花：+2 → **+5**
3.  **凶煞权重降低**:
    *   日破/岁破：-15/-12 → **-10** (降低负面冲击)
    *   五行克制扣分普遍减少 2-3 分。
4.  **文案优化**:
    *   `日柱天干生助日主` → `得天时生助，能量源源不断`
    *   `犯日破` → `日破大耗，诸事宜静`

---

## 3. 评分等级标准

由于基础分提升，评分等级阈值也相应调整：

| 分数范围 | 等级 | 颜色    | 建议                   |
| -------- | ---- | ------- | ---------------------- |
| **85-95**| 大吉 | 🟢 深绿 | 最佳时机，适合重要决策 |
| **70-84**| 吉   | 🟢 浅绿 | 能量充沛，适合行动     |
| **45-69**| 平   | 🟡 黄色 | 平稳期，处理日常事务   |
| **25-44**| 凶   | 🟠 橙色 | 需谨慎，避免重大决策   |
| **20-24**| 大凶 | 🔴 红色 | 不宜行动，静守为上     |

---

## 4. 关键函数实现

### 4.1 主计算入口 `calculateHourEnergyV2`

```javascript
export function calculateHourEnergyV2(userBazi, userGods, queryDate) {
  // ... (获取日柱、时柱)

  // 2. 基础分 (V2.1)
  let score = 60 
  const allReasons = []
  
  // 3. 各维度计算
  // ... calculateDayImpact
  // ... calculateHourImpact
  // ... calculateShenShaImpact
  // ... calculateSpecialCombo

  // 7. 分数限制与等级判定
  score = Math.max(20, Math.min(95, score))
  const levelInfo = getEnergyLevel(score)

  return {
    score,
    level: levelInfo.level,
    reasons: allReasons.join('；'),
    shenSha: shenShaImpact.stars,
    clashes: shenShaImpact.clashes
  }
}
```

### 4.2 神煞计算优化 `calculateShenShaImpact`

```javascript
export function calculateShenShaImpact(userBazi, hourPillar) {
  // ...
  
  // 1. 贵人 (天乙贵人) +18
  if (isGuiRen) {
    score += 18
    reasons.push('天乙贵人照临，遇事呈祥')
  }

  // ...

  // 5. 冲煞 -10
  if (isRiPo) {
    score -= 10
    reasons.push('日破大耗，诸事宜静')
  }
  
  // ...
}
```

---

## 5. 后续规划 (V3.0)

- **真太阳时 (True Solar Time)**: 引入经度校正，计算更精准的当地时间。
- **月柱影响**: 增加月令旺衰（得令/失令）的判断权重。
- **个性化规则**: 允许用户自定义特定活动的权重（如“我不喜欢雨天”）。

---

**文档结束**
